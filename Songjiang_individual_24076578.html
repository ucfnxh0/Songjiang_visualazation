<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Historical Changes of Songjiang District</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body { margin: 0; padding: 0; }
        #title {
        position: absolute;
        background-image: url('https://th.bing.com/th/id/R.10c18ccf8858486db288c0ea5d0e29ec?rik=Hbi4urCFqLrPmQ&riu=http%3a%2f%2fbpic.588ku.com%2fback_pic%2f00%2f01%2f89%2f37560cfbb5b40c4.jpg&ehk=PbyEl7k3kEE%2bO4M1Pg2tAYbf3stJpNxnSz14Ulg3B1E%3d&risl=&pid=ImgRaw&r=0');
        background-size: 120% auto;  
        background-position: -50px -70px;  
        background-repeat: no-repeat;
        box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
        border-radius: 3px;
        padding: 5px 15px;
        width: 100vw;
        left: 0;
        right: 0;
        top: 0;
        text-align: center;
        z-index: 9999;}
        
        #learn-more-btn {
        position: fixed !important; 
        top: 100px;
        left: 250px;
        padding: 5px 15px;
        background-color: white;
        color: black;
        border: none;
        cursor: pointer;
        font-size: 16px;
        z-index: 999999 !important;
        border-radius: 5px;}


        .learn-more-content {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        max-height: 400px; 
        background-color: white;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        z-index: 9999;
        overflow-y: auto;}

        .learn-more-content img {
        width: 100%;
        height: auto;
        margin-top: 10px;}

        #content-text {
        font-size: 14px;
        margin-bottom: 10px;}
        
        .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        color: #555;}

        .close-btn {
        position: absolute;
        top: 1px;
        right: 1px;
        background-color: white; 
        border: none;
        border-radius: 8px;
        font-size: 10px;
        font-weight: bold;
        color: black; 
        cursor: pointer;
        padding: 5px;
        transition: background-color 0.3s, color 0.3s;}

        .close-btn:hover {
        background-color: red;
        color: white;}

        .density-popup {
        position: fixed;
        bottom: 1px !important; 
        left: 2px !important;
        bottom: auto;
        width:400px;
        border-radius: 8px;
        background: white !important; 
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 9999;}

        .mapboxgl-canvas:active {
        cursor: crosshair;}

        #population-density-chart {
        width: 100% !important;
        height: 200px !important;}


        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls { 
            position: absolute; 
            top: 100px; 
            left: 10px; 
            background: white; 
            padding: 10px; 
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
       .slider-container {
       display: none;
       margin-top: 10px;
       text-align: center;}

       #time-slider {
       width: 100%;
       margin: 10px 0;
       position: relative;
       appearance: none;
       background: transparent;}

       #time-slider::-webkit-slider-runnable-track {
       width: 100%;
       height: 4px;
       background: #ddd;
       border-radius: 2px;}

       #time-slider::-moz-range-track {
       width: 100%;
       height: 4px;
       background: #ddd;
       border-radius: 2px;}

       #time-slider::-webkit-slider-thumb {
       appearance: none;
       width: 14px;
       height: 14px;
       background: #007bff;
       border-radius: 50%;
       cursor: pointer;
       margin-top: -5px; }

       #time-slider::-moz-range-thumb {
       width: 14px;
       height: 14px;
       background: #007bff;
       border-radius: 50%;
       cursor: pointer;}

       #time-slider::before {
       content: '';
       position: absolute;
       width: 100%;
       height: 10px;
       top: 50%;
       left: 0;
       transform: translateY(-50%);
       background: linear-gradient(to right, 
        transparent 0%, black 2%, 
        transparent 24%, black 26%, 
        transparent 49%, black 51%, 
        transparent 74%, black 76%, 
        transparent 100%);
       background-size: 100% 2px;
       background-repeat: no-repeat;
       background-position: bottom;}

       .mapboxgl-ctrl-top-right {
       margin-top: 100px;}
        
       .highlighted-temple {
       background-color: red; 
       border-radius: 8px; 
       border: 2px solid white; 
       width:50px!important;
       height:50px!important;}
       
       .mapboxgl-popup-content {
       overflow: auto;}

       .popup-templepoints .mapboxgl-popup-content {
       width: 300px;
       max-height: 200px !important;  
       overflow: auto; 
       padding: 10px;  }
        
       .popup-tourism .mapboxgl-popup-content {
       width: 300px;
       max-height: 200px !important; 
       overflow: auto; 
       padding: 10px; }
    </style>
</head>
<body>
     <div id="title">
        <h1>The Historical Changes of Songjiang District</h1>
    </div> 
    <button id="learn-more-btn">Learn More</button>
    
    <div id="density-popup" class="density-popup"style="display: none;">
    <div id="density-content">
         <h3 style="font-size: 15px; line-height: 1.5; margin: 10px 0;">
            Historical Change of Population Density
        </h3>

        <h4 id="location-name" style="font-size: 10px; line-height: 1; margin: 10px 0;">
            Location: 
        </h4>

        <canvas id="population-density-chart"></canvas>
    </div>
    </div>

    <div id='map'></div>
    
    <div id='controls'>
        <strong>Boundary Change</strong><br>
        <input type='checkbox' id='ancientsongjiang'> Ancient Songjiang<br>
        <input type='checkbox' id='modernsongjiang'> Modern Songjiang<br>
        <strong>Economy and Culture</strong><br>
        <input type='checkbox' id='traderoute'> Trade Route<br>
        <input type='checkbox' id='temple'> Temple<br>
        <input type='checkbox' id='spot'> Tourism Spot<br>
        <strong>Population</strong><br>
        <input type='checkbox' id='population'> Population<br>
       <div class='slider-container'>
    <input type='range' id='time-slider' min='0' max='3' step='1' value='0' list="tickmarks">
    <datalist id="tickmarks">
        <option value="0"></option>
        <option value="1"></option>
        <option value="2"></option>
        <option value="3"></option>
    </datalist>
    <span id='time-label'>1368-1398</span> 
       </div>
    </div>
    
    <div id="learn-more-content" class="learn-more-content">
    <div id="content-text"></div>
    <div id="content-image"></div>
    <div id="highlight-links"></div>
    <button class="close-btn">×</button>
    </div>
    
    
    
    
    <script>
    document.addEventListener("DOMContentLoaded", function () {
    var populationCheckbox = document.getElementById("population");
    var sliderContainer = document.querySelector(".slider-container");
    var timeSlider = document.getElementById("time-slider");
    var timeLabel = document.getElementById("time-label");
    var timePeriods = ["1368-1398", "1507-1521", "1796-1820", "1875-1908"];

    populationCheckbox.addEventListener("change", function () {
        sliderContainer.style.display = this.checked ? "block" : "none";
    });

    timeSlider.addEventListener("input", function () {
        timeLabel.textContent = timePeriods[this.value];
    });
});

        
 
    document.addEventListener('DOMContentLoaded', function() {
        var mapboxToken = "pk.eyJ1IjoieGlueXVlMjMiLCJhIjoiY203amU4bzlrMDR1ZzJvcXR2bW42Y2lmeCJ9.ctzNnLvN8LSMRuOQsa1ktg";

    mapboxgl.accessToken = mapboxToken;
    var map = new mapboxgl.Map({
        container: 'map', 
        style: 'mapbox://styles/xinyue23/cm7jevxr600p801s8drxhdcje', 
        center: [121.22, 31.03], 
        zoom: 10 
    });
    
    map.on('load', function () {
               
    console.log("Map loaded, starting to add remote sensing imagery...");

    map.addSource('satellite', {
    'type': 'raster',
    'tiles': [
        'https://api.mapbox.com/styles/v1/mapbox/dark-v10/tiles/256/{z}/{x}/{y}?access_token=' + mapboxgl.accessToken
    ],
    'tileSize': 256
    });
    mapboxgl.accessToken = 'pk.eyJ1IjoieGlueXVlMjMiLCJhIjoiY203amU4bzlrMDR1ZzJvcXR2bW42Y2lmeCJ9.ctzNnLvN8LSMRuOQsa1ktg';

    setTimeout(() =>{
        if (map.getSource('satellite')) {
            console.log("Data source ‘satellite’ is loaded, start adding layers...");
            map.addLayer({
                'id': 'satellite-layer',
                'type': 'raster',
                'source': 'satellite',
                'layout': {
                    'visibility': 'visible'}
            });
        console.log("Remote sensing imagery has been successfully added to the map!");
          
        map.moveLayer('satellite-layer', map.getStyle().layers[0].id);
        } else{
        console.error("Error: The data source ‘satellite’ is still not loaded!");
        }
    }, 1000); 


    var layers = map.getStyle().layers;

    layers.forEach(function (layer) {
        if (layer.id !== 'clip_route') {
            map.setLayoutProperty(layer.id, 'visibility', 'none');
        }
    });

    map.setLayoutProperty('clip_route', 'visibility', 'none');
    map.setLayoutProperty('ancient_songjiang_line', 'visibility', 'none');
    map.setLayoutProperty('modern_songjiang_line', 'visibility', 'none');
    map.setLayoutProperty('ancient_songjiang', 'visibility', 'none');
    map.setLayoutProperty('modern_songjiang', 'visibility', 'none');
    map.setLayoutProperty('temple', 'visibility', 'none');
    map.setLayoutProperty('ancient_pop', 'visibility', 'none');
    map.setLayoutProperty('ancient_pop_line', 'visibility', 'none');
        

    var tradeRouteCheckbox = document.getElementById('traderoute');
    var ancientSongjiangCheckbox = document.getElementById('ancientsongjiang');
    var modernSongjiangCheckbox = document.getElementById('modernsongjiang');
    var templeCheckbox = document.getElementById('temple');
    var populationCheckbox = document.getElementById('population');
    var timeSlider = document.getElementById('time-slider');
    var timeLabel = document.getElementById('time-label');
        
    var timePeriods = ["1368-1398", "1507-1521","1796-1820", "1875-1908"];
    var fieldMapping = ["I16", "I32","I22","I17"];
               
    tradeRouteCheckbox.addEventListener('change', function() {
        if (tradeRouteCheckbox.checked) {
            map.setLayoutProperty('clip_route', 'visibility', 'visible');
        } else {         
            map.setLayoutProperty('clip_route', 'visibility', 'none');
               }
    });
        
        
    ancientSongjiangCheckbox.addEventListener('change', function() {
        if (ancientSongjiangCheckbox.checked) {
            map.setLayoutProperty('ancient_songjiang_line', 'visibility', 'visible');
            map.setLayoutProperty('ancient_songjiang', 'visibility', 'visible')
        } else {
            map.setLayoutProperty('ancient_songjiang_line', 'visibility', 'none');
            map.setLayoutProperty('ancient_songjiang', 'visibility', 'none');
                }
        });
        
    modernSongjiangCheckbox.addEventListener('change', function() {
        if (modernSongjiangCheckbox.checked) {
            map.setLayoutProperty('modern_songjiang_line', 'visibility', 'visible');
            map.setLayoutProperty('modern_songjiang', 'visibility', 'visible');
        } else {
            map.setLayoutProperty('modern_songjiang_line', 'visibility', 'none');
            map.setLayoutProperty('modern_songjiang', 'visibility', 'none');
                }
        });
        
    templeCheckbox.addEventListener('change', function() {
        if (templeCheckbox.checked) {
            map.setLayoutProperty('temple', 'visibility', 'visible');
        } else {
            map.setLayoutProperty('temple', 'visibility', 'none');
                }
        });
        
    populationCheckbox.addEventListener('change', function() {
        var visibility = populationCheckbox.checked ? 'visible' : 'none';
        map.setLayoutProperty('ancient_pop', 'visibility', visibility);
        map.setLayoutProperty('ancient_pop_line', 'visibility', visibility);
        if (!this.checked) {
        document.getElementById('density-popup').style.display = 'none';
        }
    });
        
    timeSlider.addEventListener('input', function() {
        var index = parseInt(timeSlider.value);
        timeLabel.textContent = timePeriods[index];

        var field = fieldMapping[index];
        updatePopulationLayerColor(field);
    });

    function updatePopulationLayerColor(field) {
        if (map.getLayer('ancient_pop')) {
            map.setPaintProperty('ancient_pop', 'fill-color', 
           [ 'interpolate', 
           ['linear'], 
           ['get', field],
            0, '#ffffb2',
            100,  '#ffe089',
            200,  '#fec44f',
            300,  '#fe9929',
            400,  '#ff7f0e',
            500,  '#ff6600', 
            600,  '#f03b20',
            700,  '#e31a1c',
            800,  '#bd0026',
            900,  '#800026',
            1000, '#660018',
            1100, '#55000f',
            1200, '#4d0b00',
            1300, '#531400',
            1400, '#5a1f00',
            1500, '#632900',
            1600, '#8c2d04'
            ]);
        }
    }
        
        
         
    map.on('mousemove', 'ancient_songjiang', function (e) {
           if (!e.features || e.features.length === 0) return;
           var feature = e.features[0]; 
           var ID = feature.properties.ID;
           var townshipID = getTownshipID(ID);
           if (townshipID) {
               popup.setLngLat(e.lngLat)
              .setHTML(`<strong>Township Name:</strong> ${townshipID}<br><strong>Bao ID:</strong> ${ID}`)
              .addTo(map);
           }
   });

    map.on('mouseleave', 'ancient_songjiang', function () {
           popup.remove();
    });


    function getTownshipID(ID) {
    var townshipArray = ["Fengjing Township", "Fengjing Township", "Fengjing Township", "Xuipu Township", "Xuipu Township", "Xuipu Township","Xianshan Township","Xianshan Township","Yunjian Township","Yunjian Township","Yunjian Township","Yunjian Township","Baisha Township","Baisha Township","Baisha Township","Changren Township","Changren Township","Changren Township","Changren Township","Changren Township","Changren Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Gaochang Township","Beiting Township","Beiting Township","Beiting Township","Beiting Township","Huating Township","Huating Township","Huating Township","Jixian Township","Jixian Township","Jixian Township","Xiuzhu Township","Xiuzhu Township","Xiuzhu Township","Xinjiang Township","Xinjiang Township","Xinjiang Township","Haiyu Township","Haiyu Township","Haiyu Township","Haiyu Township"];
    return townshipArray[ID - 1] || "Unknown"; 
    }
        
        
    map.on('mousemove', 'modern_songjiang', function (e) {
           if (!e.features || e.features.length === 0) return;
           var feature = e.features[0]; // 获取鼠标悬浮的 feature
           var name = feature.properties.name;
           if (name) {
           var translatedName = translateToEnglish(name);
           popup.setLngLat(e.lngLat)
           .setHTML(`<strong>Name:</strong> ${translatedName}`)
           .addTo(map);
           }
    });


    map.on('mouseleave', 'modern_songjiang', function () {
          popup.remove();
    });


    function translateToEnglish(name) {
    var translationDict = {
        "九亭镇": "Jiuting Town",
        "佘山镇": "Sheshan Town",
        "新桥镇": "Xinqiao Town",
        "石湖荡镇":"Shihudang Town",
        "松江工业区":"Songjiang Industrial District",
        "新浜镇":"Xinbang Town",
        "泖港镇":"Liugang Town",
        "泗泾镇":"Sijing Town",
        "洞泾镇":"Dongjing Town",
        "永丰街道":"Yongfeng District",
        "小昆山镇":"Xiaokunshan Town",
        "岳阳街道":"Yueyang District",
        "中山街道":"Zhongshan District",
        "车墩镇":"Chedun Town",
        "方松街道":"Fangsong District",
        "叶榭镇":"Yexie Town",
    };
    return translationDict[name] || name; 
    }
        
        
    var currentTimeIndex = 0;

    var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
    });


    map.on('mousemove', 'ancient_pop', function (e) {
           if (!e.features || e.features.length === 0) return;
           var feature = e.features[0]; 
           var timePeriods = ["I16", "I32", "I22", "I17"];
        
           console.log("Current time index:", currentTimeIndex);
        
           var currentField = timePeriods[currentTimeIndex]; 
           var populationDensity = feature.properties[currentField]; 
        
           console.log("Feature Properties:", feature.properties);
           console.log("Current field:", currentField, "Population density:", populationDensity);
        
           if (populationDensity !== undefined) {
               popup.setLngLat(e.lngLat)
               .setHTML(`<strong>Population density(/km²):</strong> ${populationDensity}`)
               .addTo(map);
           }
    });


     map.on('mouseleave', 'ancient_pop', function () {
         popup.remove();
     });
        
        
     var nav = new mapboxgl.NavigationControl();
     map.addControl(nav, 'top-right');

        
    var learnMoreBtn = document.getElementById("learn-more-btn");
    var learnMoreContent = document.getElementById("learn-more-content");
    var contentText = document.getElementById("content-text");
    var contentImage = document.getElementById("content-image");
    var tradeRouteCheckbox = document.getElementById('traderoute');
    var ancientSongjiangCheckbox = document.getElementById('ancientsongjiang');
    var modernSongjiangCheckbox = document.getElementById('modernsongjiang');
    var templeCheckbox = document.getElementById('temple');
    var populationCheckbox = document.getElementById('population');

    learnMoreBtn.addEventListener('click', function() {
    const isTempleChecked = templeCheckbox.checked;

    contentText.innerHTML = "";
    contentImage.innerHTML = "";
    const linksContainer = document.getElementById('highlight-links');
    linksContainer.innerHTML = ""; 
    if (tradeRouteCheckbox.checked) {
        contentText.style.textAlign = "justify"; 
        contentText.innerHTML = "<br>During the Ming and Qing dynasties, Songjiang Prefecture was a major town of textile and handicraft industries in China, especially the cotton textile industry, which was so developed that it was known as 'the world of clothing'. These trade routes not only facilitated the circulation of local commodities, but also strengthened the economic ties between Songjiang Prefecture and the neighbouring regions and even the whole country. The development of the trade routes also led to the prosperity of the towns along the routes, forming a series of commercial towns.<br><br>Songjiang Province is located in the Yangtze River Delta, with flat terrain and a dense water network, which provided good natural conditions for the construction and development of the trade routes. The trade routes included not only land routes, but also water routes, which made full use of the advantages of the local water system and facilitated the transport of goods and the movement of people.<br><br>Huang Daopo, known as the 'originator of the cloth industry', was a native of Wunijing Town in Songjiang Prefecture. She learnt a whole set of weaving techniques from the Li people on Hainan Island and brought them back to her hometown.";
        contentImage.innerHTML = '<img src="https://whb.cn/u/cms/www/201805/01110938y8em.JPG" alt="Huang Daopo">'; 
    } else if (ancientSongjiangCheckbox.checked) {
        contentText.style.textAlign = "justify"; 
        contentText.innerHTML = "<br>The earliest history of Songjiang can be traced back to <b>the Spring and Autumn Period</b>, when it belonged to a region of the Wu State, and then passed through a number of dynasties. <br><br>During the <b>Sui Dynasty</b>, Songjiang began to be established as a county-level administrative unit. <br><br>During the <b>Tang</b> Dynasty, Songjiang became a more important region and gradually became one of the major cities in Jiangnan.<br><br>By the <b>Song</b> Dynasty, Songjiang Prefecture's status was elevated and it became a major town in the southern part of the Yangtze River. <br><br>During the <b>Yuan</b> Dynasty, Songjiangfu gradually became one of the political, economic and cultural centres around Shanghai. <br><br>During the <b>Ming</b> and Qing Dynasties, Songjiangfu's status became even more prominent, and it was an important prefecture in the Jiangnan region.<br><br>Historically, Songjiangfu was not only an administrative region, but also famous for its rich cultural heritage and historical figures. Many literati and historical figures, such as Ma Xuezheng and Lu Xiufu, had a deep connection with Songjiang.<br><br>The concept of Songjiang Prefecture was established from the Ming and Qing Dynasties. The map on this page shows the administrative division of Songjiang Prefecture during the Ming and Qing Dynasties, which was divided into 13 townships, 50 baos.";
        contentImage.innerHTML = '<img src="https://i0.hdslb.com/bfs/article/9df520ca0deb619d361a6a7e8f6191f8441f52c9.jpg@1192w.avif"alt="Ancient map">'; 
    } else if (modernSongjiangCheckbox.checked) {
        contentText.style.textAlign = "justify"; 
        contentText.innerHTML = "<br>Songjiang District, a municipal district of Shanghai, is located in the southwestern part of the city, with a total area of 604.64 square kilometres. As of 2023, the district had a population of 1.974 million.<br><b>The first year of the Republic of China (1912)</b><br>the government was abolished. Parts of Baisha Township, Yunjian Township, and Xupu Township were merged to form Huating County, which came under the jurisdiction of Jiangsu Province.<br><b>After the establishment of the People's Republic of China</b><br><b>1952</b><br>After restoring the establishment of Jiangsu Province, Songjiang Prefecture came under Jiangsu Province.<br><b>March 1958</b> <br>Songjiang Prefecture of Jiangsu Province was cancelled and Songjiang County was transferred to Suzhou Prefecture.<br><b>November</b><br> Songjiang County was transferred to Shanghai.<br><b>February 1998</b><br>The State Council approved the abolition of the county and the establishment of the district.<br>";
        contentImage.innerHTML = '<img src="http://wenhui.whb.cn/u/cms/www/201911/112007321bzt.png"alt="modern picture">'; 
    } else if (templeCheckbox.checked) {
        contentText.style.textAlign = "justify"; 
        contentText.innerHTML = "<br>In the Ming and Qing Dynasties, Songjiang Prefecture was the center of the national cotton textile industry, and its economic prosperity led to the prosperity of religious belief.<br><br>Religious activities include not only the traditional Buddhist and Taoist pujas and temple festivals, but also the six beliefs and five practices of Islam, the Christmas, Easter and Thanksgiving activities of Catholicism, Christianity and Orthodox Christianity, and the Passover and Pentecost festivals of Judaism. These religious activities contributed to the formation and spatial perfection of the town, and their own belief system also developed towards increasing secularisation and commercialisation, laying the foundation for the development of the highly heterogeneous 'Haikai religious culture' in modern Shanghai.<br>";
        contentImage.innerHTML = '<img src="https://kimi-img.moonshot.cn/webimg2/5b0988e595225.cdn.sohucs.com/4d89d00455177de4c7c10b36781eb0bef3274923?x-tos-process=image%2Fresize%2Cw_530" alt="Ancient religious">'; 
       
        
    const templeIDs = [17,15,1052,19,205,23,1161,130,154,45]; 
    const templeInfo = {
    17: "Xilin Zen Monastery",
    15: "Songjiang Mosque",
    1052: "Songjiang Dongyue Temple",
    19: "Tianfei Palace",
    205: "Guanding Zen Monastery",
    23: "Songjiang Thirty-three Guanyin Hall",
    1161: "Zhiye Zen Monastery",
    130: "Shangfeng Temple",
    154: "Jiufeng Zen Monastery",
    45: "Dafang Zen Monastery"
    };
    const linksContainer = document.getElementById('highlight-links');
    linksContainer.innerHTML = '<strong>Famous Religious Sites in Songjiang Prefecture(click to explore)</strong><br>';
        
    Object.keys(templeInfo).forEach(ID => {
    linksContainer.innerHTML += 
        `<a href="#" class="highlight-link" data-id="${ID}">${templeInfo[ID]}</a><br>`;
    });
    } else if (populationCheckbox.checked) {
        contentText.style.textAlign = "justify"; 
        contentText.innerHTML = "<br>The page shows the population density in four periods: Ming Hongwu, Ming Zhengde, Qing Jiaqing, and Qing Guangxu.<br><b>Ming Dynasty, Hongwu Period(1368-1398)</b><br>Due to the war at the end of the Yuan Dynasty, which led to a significant reduction in population, the Ming government adopted a large-scale immigration policy , which contributed to the growth of the population in the Jiangnan region.<br><b>Ming Dynasty, Zhengde Period(1507-1521)</b><br>From the beginning of the fifteenth century onwards, the lijia system of the Ming Dynasty began to break up, leading to social disintegration and the dispersal of peasants from various parts of the countryside.<br>Furthermore, due to the non-registration of slaves and women, as well as the large-scale concealment of household registrations, there was a significant discrepancy between the population recorded and the actual population.<br><b>Qing Dynasty, Jiaqin Period(1796-1820)</b><br>Benefited from improvements in agricultural technology (e.g., increased rice production, introduction of sweet potatoes) during the Kangxi and Qianlong periods.<br><b>Qing Dynasty, Guangxu Period(1796-1820)</b><br>During the Xianfeng and Tongzhi periods (1850s-1870s) before the Guangxu period, China experienced the Taiping Heavenly Kingdom War, which took place mainly in the south, especially in the Yangtze River Valley (including Jiangsu, Zhejiang, and Anhui), and wreaked great destruction in the area of Songjiang Prefecture.<br>After the Taiping Heavenly Kingdom War, the economy of Jiangnan failed to fully recover, and coupled with the economic aggression of the Great Powers (such as the opium trade and the opening of the ports of communication), it had an impact on the local agricultural economy. Natural disasters and plagues, etc. also ran rampant during this period.";
        contentImage.innerHTML = '<img src="https://p3.itc.cn/images01/20200624/7aadce1c49ed49c58ff1b7c3de9cb8ac.jpeg" alt="Population">'; 
         } else if (tourismCheckbox.checked) {
             contentText.style.textAlign = "justify"; 
             contentText.innerHTML = "<br>Apart from the temples that still exist, there are also some famous tourist attractions. Please click on the points on the page to explore.";
         
    } else {
        contentText.innerHTML = "Please select an option to learn more.";
        contentImage.innerHTML = '';
    }

    
    learnMoreContent.style.display = "block";
    });
        
    var closeBtn = document.querySelector(".close-btn");
    closeBtn.addEventListener('click', function() {
    console.log("Close button is clicked");
    learnMoreContent.style.display = "none";});

     document.addEventListener('click', function(e) {
    if (e.target.classList.contains('highlight-link')) {
        e.preventDefault();
        const templeId = e.target.dataset.id;
        highlightTemple(templeId);
    }
    });


    function highlightTemple(ID) {
    console.log('try hightlighted ID：', ID);
     if (!ID) {
        console.error('invalid ID');
        return;
    }
    if (!map.getLayer('temple')) {
        console.error('temple has not loaded');
        return;
    }
    
    map.setPaintProperty('temple', 'circle-color', [
        'case',
        ['==', ['get', 'ID'], parseInt(ID)],
        '#FFFF00',  
        '#888888',  
        
    ]);
    map.setPaintProperty('temple', 'circle-radius', [
    'case',
    ['==', ['get', 'ID'], parseInt(ID)],
    12,  
    6    
    ]);
    }


    map.on('click', 'temple', function(e) {
    const feature = e.features[0];
    const featureID = String(feature.properties.ID);

    
    let content;
    switch (featureID) {
        case '17':
            content = `<h3>Xilin Zen Monastery</h3><p style="text-align: justify; word-spacing: 2px;">It was built in Tang Xian Tong thirteen years (872), so far has a history of more than a thousand years. In front of the temple, there is a pagoda with seven layers and eight sides, named ‘Chongen Pagoda’, which is magnificent. It is a typical temple and pagoda Buddhist architectural complex. In November 1986, the former abbot of the monk Xu Ming presided over the restoration. In September 1987, Xilin Zen Monastery was reopened.<br><img src="http://img.pconline.com.cn/images/upload/upc/tx/itbbs/1906/02/c18/150996552_1559490320124.jpg" alt="Xilin Zen Monastery"style="width:100%; max-width:300px; height:auto;"></p>`;
            break;
        case '15':
            content = `<h3>Songjiang Mosque</h3><p style="text-align: justify; word-spacing: 2px;">It was built in 1341, the first year of the Yuan Dynasty, because the governor of the area at that time was a Muslim. It is known as the ‘White Crane Temple among the Clouds’. It is the oldest Islamic building in Shanghai. It was rebuilt by order of the government in the Ming Dynasty (1391), then expanded three times, and renovated four times in the Qing Dynasty, so it still maintains the style of mosques in the Yuan and Ming Dynasties.<br><img src="https://th.bing.com/th/id/R.d475264c4401c48c6802358989778dc9?rik=gQ4SOnjgO%2bofeQ&riu=http%3a%2f%2fk.sinaimg.cn%2fn%2fsinakd20220705s%2f288%2fw1080h808%2f20220705%2fee5c-8b2c5553a795ef7a8465c78fc016e483.jpg%2fw700d1q75cms.jpg&ehk=0I%2bJk8u2hSoJ46QpbNQD53W2hvZ8GMwkXDFBGzCFRIs%3d&risl=&pid=ImgRaw&r=0" alt="Songjiang Mosque"style="width:100%; max-width:300px; height:auto;">The existence of the temple and the tomb of the building is a blend of Chinese and Albanian culture, especially the kiln hall, Bunker House and Daru Huachi tomb, has a strong period characteristics and precious historical and artistic value.<br><img src="https://xlhc.net/wp-content/uploads/%E4%B8%8A%E6%B5%B7%E6%9D%BE%E6%B1%9F%E6%B8%85%E7%9C%9F%E5%AF%BA.jpg" alt="Bunker House"style="width:100%; max-width:300px; height:auto;"></p><p style="text-align: center;">Bunker House</p>`;
            break;
        case '1052':
            content = `<h3>Songjiang Dongyue Temple</h3><p style="text-align: justify; word-spacing: 2px;">When it was built is not known, Song Shangshu Youcheng(a high official in ancient China) Zhu E began to expand the building.<br>In the past, it was the busiest place in Songjiang, and it carried the memories of generations of Songjiang people.<br>The picture shows the opening ceremony of the traditional temple fair and the ceremonies of the birthdays of The Holy Emperor of Dongyue and Yang Daishin.<br><img src="http://img.mp.sohu.com/upload/20170425/0e7391fb136a4fe7af5c5685527a1138_th.jpeg" alt="Songjiang Dongyue Temple"style="width:100%; max-width:300px; height:auto;"></p>`;
            break;
        case '19':
            content = `<h3>Tianfei Palace</h3><p style="text-align: justify; word-spacing: 2px;">It is the only surviving remnant of an A-Ma temple in the present-day Shanghai area. Tianfei is A-Mazu, a sea goddess belief centred on the south-east coast of China, also known as Tin Hau, Heavenly Mother, Niang Ma, etc. It is a deity shared by shipwrights, seafarers, travellers, merchants and fishermen throughout the ages. A-Ma Zu, a deity who became a god from mortal flesh, was a native of the Song Dynasty, originally named Lin Mo, who died after rescuing a shipwreck. Ancient people remembered Lin Mo's feat, and she was legendary as a god who descended to the world to save people.<br><img src="https://pic4.zhimg.com/v2-a758fa14eff355620185097400b84495_1440w.jpg" alt="A-Ma picture in Tianfei Palace"style="width:100%; max-width:300px; height:auto;"></p>`;
            break;
        case '205':
            content = `<h3>Guanding Zen Monastery</h3><p style="text-align: justify; word-spacing: 2px;">Guanding Zen Temple is the Shuiji Cang Guandi Temple, which was renamed ‘Guanding Zen Temple’ in the Qianlong period of the Qing Dynasty. It is dedicated to the holy statue of Guan Gong.Guan Gong is a real historical figure from the Three Kingdoms period, honoured as a god of loyalty and righteousness, symbolising honesty and integrity. He is regarded as the protector of the Dharma in Buddhism.<br><img src="https://th.bing.com/th/id/OIP.NC6ZL1YZLOdZDQ4_pzFy2gHaLC?rs=1&pid=ImgDetMain" alt="Guan Gong"style="width:100%; max-width:300px; height:auto;"> ‘Guan’ means to instil, indicating the protection and compassion of the Buddhas; ‘Ding’ means the top of the head, representing the sublimity of Buddhist practice. Buddhist ‘Guanding’ embodies the transmission of Buddhist wisdom.' Guanding' is able to awaken the special energy in the practitioner's heart, thus establishing a communication between teaching and learning, inspiring the disciple's inner potential, and setting him or her on the path of good cultivation until complete fulfilment.<br><img src="https://img.pusa123.com/www/uploads/allimg/160612/17596_160612125928_3.jpg" alt="Guan Gong"style="width:100%; max-width:300px; height:auto;"></p>`;
            break;
        case '23':
            content = `<h3>Songjiang Thirty-three Guanyin Hall</h3><p style="text-align: justify; word-spacing: 2px;">It was first built during the Chongzhen period of the Ming Dynasty (1628-1644). During the late Qing Dynasty and the Republic of China, it was also used as the site of two schools. The interior is dedicated to the Thirty-three Guanyin statues.<br><img src="https://dimg04.c-ctrip.com/images/0HJ6112000g6reurl0618_C_1600_1200.jpg" alt="Guanyin"style="width:100%; max-width:300px; height:auto;"></p>`;
            break;
        case '1161':
            content = `<h3>Zhiye Zen Monastery</h3><p style="text-align: justify; word-spacing: 2px;">According to legend, in the late Tang Dynasty, one day, a monk called ‘Dazhi’ travelled from Luoyang to this place, and was deeply attracted by the beautiful scenery of nine peaks surrounded by green, so he had the idea of building a temple here to promote Buddhism. So, he went around to make money.In Hua Ting County, where the people were well fed and clothed, there were many donors, Zen Master Dazhi, after ten years of travelling, was able to obtain a large sum of money. He used the money to have a great temple built on a place surrounded by water, and a stone bridge built on the river to the east of the temple to facilitate passage.<br><img src="https://bkimg.cdn.bcebos.com/pic/71cf3bc79f3df8dc415a9984c211728b471028bb?x-bce-process=image/format,f_auto/watermark,image_d2F0ZXIvYmFpa2UyNzI,g_7,xp_5,yp_5,P_20/resize,m_lfit,limit_1,h_1080" alt="Zhiye"style="width:100%; max-width:300px; height:auto;" </p>`;
            break;
        case '130':
            content = `<h3>Shangfeng Temple</h3><p style="text-align: justify; word-spacing: 2px;">It was built in the thirteenth year of Dazhong of Tang Dynasty (859 years). In 1157, the Emperor of Song Dynasty gave five-coloured relics to be hidden in the tower, and the legend said that it let out a precious light, so it was also known as Protecting the Jewellery Light Pagoda. Later, the tower was destroyed.Today the remains of this thousand-year-old tower still exist, the tower's inclination exceeds that of the Leaning Tower of Pisa, which can be regarded as the world's first leaning tower.<br><img src="https://p5.itc.cn/images01/20221225/fa8c534aa19142a4bac71e868566353f.jpeg" alt="Tower"style="width:100%; max-width:300px; height:auto;"<br><img src="https://p6.itc.cn/images01/20221225/fc9517b564a94425bf16467039494c3a.jpeg" alt="Tower2"style="width:100%; max-width:300px; height:auto;" </p>`;
            break;
        case '154':
            content = `<h3>Jiufeng Zen Monastery</h3><p style="text-align: justify; word-spacing: 2px;">It was built in 1165, the first year of the Qian Dao era in the Southern Song Dynasty. In 1705, when Emperor Kangxi was on his southern tour, he bestowed the imperial inscription ‘Kui Star's Radiance and Candle's Shadow’, which made it one of the most famous temples in the south.<br><img src="https://th.bing.com/th/id/R.d0871bcd9e9aeb4c63b1167fde00ee7c?rik=F0Sv17aQ639sWw&riu=http%3a%2f%2fp3.toutiaoimg.com%2forigin%2f613a00107b07b6aaad77&ehk=x42ZsbVWVmnLYG6W86gemoyq5tXuxfND9s2VQvp9vBY%3d&risl=&pid=ImgRaw&r=0" alt="Jiufeng"style="width:100%; max-width:300px; height:auto;"</p>`;
            break;
        case '45':
            content = `<h3>Dafang Zen Monastery</h3><p style="text-align: justify; word-spacing: 2px;">The Da Fang Zen Temple was built in the middle of the Qing Dynasty. In 1927, when Chen Yun led the revolutionary struggle of the people of Qingpu and launched the Fengjing Peasants' Insurrection, this place was the seat of the command headquarters of the peasants' insurrection.<br><img src="https://bkimg.cdn.bcebos.com/pic/f703738da97739128a307fc1f8198618367ae278?x-bce-process=image/format,f_auto/watermark,image_d2F0ZXIvYmFpa2UyNzI,g_7,xp_5,yp_5,P_20/resize,m_lfit,limit_1,h_1080" alt="Jiufeng"style="width:100%; max-width:300px; height:auto;"</p>`;
            break;
        default:
            content = `<h3>${featureID}</h3><p>There is no description defined for this ID.</p>`;
            break;
    }
    var popup = new mapboxgl.Popup({ className: 'popup-templepoints'
    })
        .setLngLat(e.lngLat)
        .setHTML(content)
        .addTo(map);
    });


    map.on('mouseenter', 'temple', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'temple', () => map.getCanvas().style.cursor = '');       
        
        
    let populationChart = null;

    map.on('click', 'ancient_pop', function(e) {
    const populationChecked = document.getElementById('population').checked;
    if (!populationChecked) {
       
        return; 
    }
    const feature = e.features[0];
    const props = feature.properties;
    const densityData = {
        labels: ["1368-1398", "1507-1521", "1796-1820", "1875-1908"],
        values: [
            parseFloat(props.I16) || 0, 
            parseFloat(props.I32) || 0, 
            parseFloat(props.I22) || 0,  
            parseFloat(props.I17) || 0   
        ]
    };


    const popup = document.getElementById('density-popup');
    document.getElementById('location-name').textContent = 
        `Location: ${getTownshipID(feature.properties.ID)} (ID: ${feature.properties.ID})`;
    popup.style.display = 'block';

    if (populationChart) populationChart.destroy();
    const ctx = document.getElementById('population-density-chart').getContext('2d');
    populationChart = new Chart(ctx, {
         type: 'bar',
         data: {
         labels: densityData.labels,
         datasets: [{
            label: 'Population Density', 
            data: densityData.values,
            backgroundColor: [
                'rgba(74, 144, 226, 0.8)',  
                'rgba(29, 185, 84, 0.8)',   
                'rgba(255, 94, 91, 0.8)',   
                'rgba(156, 102, 245, 0.8)'],
            borderWidth: 1
        }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            background: {
                color: 'white' },
            title: {
                display: false,
                text: 'Historical Population Density',
                color: '#333',
                font: { size: 16, weight: 'bold' },
                padding: 20},
            legend: {
                display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: { 
                    display: true,
                    text: 'Population Density (persons/km²)',
                    color: '#333',
                },
               grid: { display: false},
            ticks: {color: '#000000' },
            border: {
                color: '#000000', 
                width: 1}
            },
            x: {
                title: { 
                    display: true,
                    text: 'Time period',
                    color: '#333'
                },
                 grid: { display: false},
                ticks: {color: '#000000' },
            border: {
                color: '#000000', 
                width: 1}
            }
        }
       }
      });
      });
        
        
      var tourismCheckbox = document.getElementById('spot');
      var tourismMarkers = []; 
      var tourismSpots = [
        { name: "Sijing Ancient Town ", lng: 121.2623, lat: 31.1221 ,
          description: `
            <h3>Sijing Ancient Town</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                The ancient town has 53 historical buildings and has nurtured a large number of historical and cultural celebrities such as Tao Zongyi, a famous historian, Fan Yunlin, a painter and calligrapher in Ming Dynasty, Ma Xiangbo, the founder of Fudan University, and Shi Liangcai, the founder of ‘Declaration’. This area has an important past humanistic memory of Songjiang and even Shanghai's history and culture.
            </p><br>
            <img src="http://news.cjn.cn/zjjjdpd/sh_20054/202211/W020221106340934347826.jpg" 
                 alt="Sijing Ancient Town" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name: "Cangcheng Old Street", lng: 121.2257, lat: 31.0023 ,
        description: `
            <h3>Cangcheng Old Street</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                It is known as the oldest old street in Shanghai. Since the Ming Dynasty, Cangcheng has been an important storage place for Songjiang Prefecture's grain and the starting point of the canal transport. The river is crisscrossed with bridges, houses, shops and temples built along the old city river, making it another lively centre of the city outside the West Guyang Gate of Songjiang Prefecture at that time. The Da Cang Bridge is an iconic sight.
            </p><br>
            <img src="https://pics5.baidu.com/feed/377adab44aed2e7317f1b4adfc89538286d6faad.png@f_auto?token=424e537beac9698c8db474b2474b93e4" 
                 alt="The Da Cang Bridge" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name: "Lu Fishing Bay", lng: 121.0628, lat: 30.9541,
        description: `
            <h3>Lu Fishing Bay</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                As early as during the Ming Dynasty, this was a prosperous township in the neighbourhood, known as ‘Liudian Bay’. Later, a hermit named Lu Li came from Kunshan and fished every day at the South Bay Harbour in the south of the town, and the town was renamed Lu Fishing Bay over time.
            </p><br>
            <img src="https://imagepphcloud.thepaper.cn/pph/image/247/850/229.jpg" 
                 alt="Lu Fishing Bay" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name: "Zuibaichi Park", lng: 121.2319, lat: 31.0015,
        description: `
            <h3>Zuibaichi Park</h3>
            <img src="https://pics0.baidu.com/feed/d1a20cf431adcbef999eb6556ff2ead1a2cc9fa2.jpeg@f_auto?token=523f5ed89e16167e51f2374d8e123afe" 
                 alt="Zuibaichi Park" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Sheshan National Forest Park", lng:121.1889, lat:31.0965,
        description: `
            <h3>Sheshan National Forest Park</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                The only national forest park in Shanghai. There are dense forests, fresh air, and fascinating observatories and churches.
            </p><br>
            <img src="https://pics1.baidu.com/feed/4b90f603738da97754e4a4e90f0c3c158418e397.jpeg@f_auto?token=a7fd3653ae882821dfaf89fd08a92108" 
                 alt="Sheshan National Forest Park" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Shanghai Happy Valley", lng:121.2156, lat:31.0975,
         description: `
            <h3>Shanghai Happy Valley</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                Large Theme Parks.
            </p><br>
            <img src="https://pics3.baidu.com/feed/8b13632762d0f70388cc2da7cba795312697c53d.jpeg@f_auto?token=1209b91a93e53b6750b81be0693a4d6d" 
                 alt="Shanghai Happy Valley" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Kwong Fu Lam cultural heritage site", lng:121.2043, lat:31.0542,
        description: `
            <h3>Kwong Fu Lam cultural heritage site</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                It is a tourist attraction that combines culture, history, art and natural landscape. It mainly includes buildings and sculptures from the Song Dynasty to the Ming and Qing Dynasties.
            </p><br>
            <img src="https://pics4.baidu.com/feed/42a98226cffc1e170b21408889cd320f728de95c.jpeg@f_auto?token=4823b77dd78abbfc1a165e17edbd3e35" 
                 alt="Kwong Fu Lam cultural heritage site" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Songjiang Museum", lng:121.2335, lat:31.0041,
        description: `
            <h3>Songjiang Museum</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                This is a comprehensive local museum with a collection of more than 5,000 pieces of history, culture, and cultural relics, including ceramics, jade, gold, silver, copper, and wood. You can get an insight into the past, present and future of Songjiang here.
            </p><br>
            <img src="https://pics1.baidu.com/feed/6a63f6246b600c33ee24b259d9119503d8f9a1a8.jpeg@f_auto?token=6c2e9924cb798540d94803ca81552c76" 
                 alt="Songjiang Museum" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Chedun Film and TV Base", lng:121.3125, lat:31.0167,
        description: `
            <h3>Chedun Film and TV Base</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                It is a film location in Shanghai, recreating the classic scenes and buildings of Shanghai in the last century.
            </p><br>
            <img src="https://th.bing.com/th/id/R.976852de98ccdc868546a49c497c8961?rik=zoRNwYJX3eb7fg&pid=ImgRaw&r=0" 
                 alt="Chedun Film and TV Base" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Shanghai Chenshan Botanical Garden", lng:121.1887, lat:31.0712,
        description: `
            <h3>Shanghai Chenshan Botanical Garden</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                It is a 4A comprehensive botanical garden integrating scientific research, popular science and ornamental tour.
            </p><br>
            <img src="https://pics3.baidu.com/feed/48540923dd54564e1a9546547383588ed0584f51.jpeg@f_auto?token=0d395e34c49f7722061551457e7f7a88" 
                 alt="Chenshan" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`},
        { name:"Shanghai Yuehu Sculpture Park", lng:121.1968, lat:31.1036,
        description: `
            <h3>Shanghai Moon Lake Sculpture Park</h3>
            <p style="text-align: justify; word-spacing: 1px;font-size: 14px;">
                One of the largest parks in Songjiang. Moon Lake Park is known for its beautiful natural landscape and rich cultural activities.
            </p><br>
            <img src="https://pics1.baidu.com/feed/d50735fae6cd7b8941917099cd7986abd8330e91.jpeg@f_auto?token=01fa83950a6adf23dfe7eedc73988ce6" 
                 alt="Shanghai Yuehu Sculpture Park" 
                 style="width:100%; max-width:300px; height:auto; display:block; margin: 0 auto;">`}
        
    ];

    
    tourismCheckbox.addEventListener('change', function() {
        if (tourismCheckbox.checked) {
            tourismSpots.forEach(spot => {
                var popupContent = `${spot.description}`;
                var marker = new mapboxgl.Marker({ color: "blue" })
                    .setLngLat([spot.lng, spot.lat])
                    .setPopup(new mapboxgl.Popup({ className: 'popup-tourism' }).setHTML(popupContent))
                    .addTo(map);

                tourismMarkers.push(marker); 
            });
        } else {
            tourismMarkers.forEach(marker => marker.remove());
            tourismMarkers = []; 
    }
    });
        
        
         
    });
    });
         
    </script>
</body>
</html>

